parameters:
  azureContainerRegistry: ''
  applicationName: ''
  azureProdSubscription: ''
  azureDestinyContainerRegistry: ''

steps:
  - template: ./tasks/docker-tag.yaml
  - bash: |
      repo_sha=$(git rev-parse --verify HEAD)
      docker_image_tag_sha=${repo_sha:0:7}
      echo "##vso[task.setvariable variable=DOCKER_TAG;isOutput=true]merge-${docker_image_tag_sha}"
    displayName: 'Get Docker Tag'
    name: 'getDockerTag'
  - bash: |
      repo_sha=$(git rev-parse --verify HEAD)
      docker_image_tag_sha=${repo_sha:0:7}
      echo "##vso[task.setvariable variable=DOCKER_PROD_TAG;isOutput=true]prod-${docker_image_tag_sha}"
    displayName: 'Get Docker Tag'
    name: 'getDockerProdTag'
  - task: AzureCLI@1
    displayName: "Acr promote"
    inputs:
      azureSubscription: ${{ parameters.azureProdSubscription }}
      scriptLocation: "inlineScript"
      inlineScript: |
        sourceImage=${{ parameters.azureContainerRegistry }}/${{ parameters.applicationName }}:$(imageTag)
        targetImage=${{ parameters.applicationName }}:$(imageTag)
        az acr import -n  ${{ parameters.azureDestinyContainerRegistry }} --source $sourceImage --image $targetImage --username  $(sp.user) --password $(sp.password)