parameters:
  azureContainerRegistry: ''
  azureSubscriptionEndpoint: ''
  applicationName: ''
  azureDestinyContainerRegistry: ''
  azureProdSubscription: ''
  azureProdResourceGroup: ''
  azureOriginSubscription: ''
  user: ''
  password: '
steps:
    - bash: |
        repo_sha=$(git rev-parse --verify HEAD)
        docker_image_tag_sha=${repo_sha:0:7}
        echo "##vso[task.setvariable variable=DOCKER_TAG;isOutput=true]merge-${docker_image_tag_sha}"
      displayName: 'Get Docker Tag'
      name: 'getDockerTag'
    - bash: |
        repo_sha=$(git rev-parse --verify HEAD)
        docker_image_tag_sha=${repo_sha:0:7}
        echo "##vso[task.setvariable variable=DOCKER_PROD_TAG;isOutput=true]prod-${docker_image_tag_sha}"
      displayName: 'Get Docker Tag'
      name: 'getDockerProdTag'
    - task: AzureCLI@1
      displayName: "Acr promote"
      inputs:
        azureSubscription: ${{ parameters.azureProdSubscription }}
        scriptLocation: "inlineScript"
        inlineScript: |
          sourceRegistry=/subscriptions/${{ parameters.azureOriginSubscription }}/resourceGroups/${{ parameters.azureProdResourceGroup }}/providers/Microsoft.ContainerRegistry/registries/ssprivatesbox
          sourceImage=${{ parameters.azureContainerRegistry }}/:${{ parameters.applicationName }}:$(getDockerTag.DOCKER_TAG)
          targetImage=${{ parameters.azureDestinyContainerRegistry }}/${{ parameters.applicationName }}:$(getDockerProdTag.DOCKER_PROD_TAG)
          az acr import -n  ssprivatetest --source $sourceImage -t $targetImage -r $sourceRegistry --username  $(sp.user) â€“-password $(ssprivatesbox)